# nginx.conf — VERSÃO FINAL 2025 (copia e cola)
server {
  listen 80;
  server_name meuplanotim.com.br localhost;
  root /usr/share/nginx/html;
  index index.html;

  # ==============================================================
  # 1. MANIFEST.JSON — ESSENCIAL (sempre na raiz de cada micro)
  # ==============================================================
  location ~ ^/(core|mf-home|timcontrole)/manifest\.json$ {
    try_files $uri =404;
    add_header Content-Type application/json;
    add_header Cache-Control "public, max-age=60, stale-while-revalidate=300";
    # Atualiza a cada minuto, mas permite cache por 5 min se o servidor cair
  }

  # ==============================================================
  # 2. remoteEntry.js (com ou sem hash) — NUNCA CACHEIA
  # ==============================================================
  location ~ ^/(core|mf-home|timcontrole)/remoteEntry(\.[A-Za-z0-9]+)?\.js$ {
    try_files $uri =404;
    add_header Content-Type application/javascript;
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
    add_header Pragma "no-cache";
    add_header Expires "0";

    # OPCIONAL: bloqueia acesso direto (só permite se vier do seu domínio)
    # if ($http_referer !~ ^(https?://(meuplanotim\.com\.br|https?://localhost)) {
    #   return 403;
    # }
  }

  # ==============================================================
  # 3. Arquivos internos do Module Federation (chunks, shared, etc)
  # ==============================================================
  location ~ ^/(core|mf-home|timcontrole)/(chunks|assets)/ {
    try_files $uri =404;
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";

    # Bloqueia acesso direto (opcional, mas recomendado em prod)
    # if ($http_referer !~ ^(https?://meuplanotim\.com\.br|https?://localhost)) {
    #   return 403;
    # }
  }

  # ==============================================================
  # 4. Assets estáticos com cache longo (imagens, fontes, css)
  # ==============================================================
  location ~ ^/(core|mf-home|timcontrole)/.*\.(png|jpg|jpeg|gif|svg|ico|woff2?|ttf|eot|webp|css)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
  }

  # ==============================================================
  # 5. Pasta /core/ (remote puro)
  # ==============================================================
  location /core/ {
    try_files $uri $uri/ =404;
  }

  # ==============================================================
  # 6. Pasta /mf-home/ ou /timcontrole/ (app com HTML)
  # ==============================================================
  location /timcontrole/ {
    try_files $uri $uri/ /mf-home/index.html;
  }

  location /mf-home/ {
    try_files $uri $uri/ /mf-home/index.html;
  }

  # ==============================================================
  # 7. Raiz do site (container/shell/container)
  # ==============================================================
  location / {
    try_files $uri $uri/ /index.html;
  }

  # ==============================================================
  # 8. Cache geral para JS/CSS fora das pastas acima
  # ==============================================================
  location ~* \.(js|css)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Content-Type application/javascript;
  }

  # ==============================================================
  # 9. Segurança e compressão
  # ==============================================================
  gzip on;
  gzip_vary on;
  gzip_min_length 1024;
  gzip_types
    text/plain
    text/css
    application/javascript
    application/json
    application/manifest+json;

  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}